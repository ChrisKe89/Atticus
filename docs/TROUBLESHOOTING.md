# TROUBLESHOOTING — Atticus

This guide covers common setup issues, ingestion problems, and quick diagnostics for Atticus deployments.

---

## Windows Setup Issues

- **Tesseract / Ghostscript**
  - Ensure both are installed and added to the system `PATH`.
  - If OCR or PDF parsing fails, verify their paths by running `tesseract --version` and `gswin64c --version`.

- **Python Wheels for 3.12**
  - If a dependency fails to build, rerun:

    ```bash
    pip install -r requirements.txt
    ```

    to rebuild compatible wheels.

- **Magic link smoke-test (PowerShell)**
  - Start the services:

    ```powershell
    make api
    make web-dev
    ```

  - Request a magic link and inspect the debug inbox:

    ```powershell
    Get-Content -Path "$env:AUTH_DEBUG_MAILBOX_DIR/*.eml"
    ```

  - If the link fails, confirm `NEXTAUTH_URL` and `AUTH_SECRET` are present in `.env` and restart both processes.

---

## PDF Parsing & Ingestion

- Prefer the **native text layer** for PDF extraction.
- OCR fallback is triggered only if no text layer is detected.
- After ingestion, verify that the number of chunks and token ranges match expectations in `logs/app.jsonl`.
- If duplicate chunks persist, inspect `seeds/seed_manifest.json` (generated by `make seed`) to confirm SHA-256 hashes differ.

Common ingestion checks:

- `.env` missing → run `python scripts/generate_env.py`.
- Unexpectedly small chunk counts → confirm `CHUNK_*` settings in `.env`.

---

## pgvector & Prisma

- **`pgvector extension not installed`** — run `make db.up` to ensure Postgres is online, then:

  ```bash
  make db.verify
  ```

  ```powershell
  make db.verify
  ```

  The script enables the extension when migrations run; if verification still fails, connect with psql and execute `CREATE EXTENSION IF NOT EXISTS vector;` manually before retrying `npx prisma migrate deploy`.

- **Embedding dimension mismatch** — export `PGVECTOR_DIMENSION` to the value used by the ingestion pipeline (default `3072`) and re-run `make db.verify`. Update `atticus/config.py` if the embeddings service changes dimension.
- **IVFFlat index missing or stale** — rerun migrations (`npx prisma migrate deploy`) and then `make db.verify`. The migration recreates `idx_atticus_chunks_embedding` with the configured `PGVECTOR_LISTS` default (`100`).

---

## SMTP / Email Escalation

- Verify all SMTP settings in `.env`: `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`, `CONTACT_EMAIL`, and `SMTP_ALLOW_LIST`.
- Check network/firewall rules if emails do not send.
- Use the built‑in test:

  ```bash
  make smtp-test
  ```

_Error codes:_ `recipient_not_allowed` or `sender_not_allowed` indicate allow-list misconfiguration. Update `SMTP_ALLOW_LIST` to include the relevant address or domain.

---

## FastAPI / UI

- If the API fails to start:
  - Run `make lint` and `make typecheck` to catch syntax or typing errors.
  - Check logs in `logs/errors.jsonl` for stack traces.
- Confirm the UI is accessible at `http://localhost:3000/` via `make web-dev`.
  If the UI has been separated again, reintroduce a dedicated make target and update port mapping.

## Streaming `/api/ask` Issues

- **No stream events received**
  - Ensure the UI or client sends `Accept: text/event-stream`. The shared helper in `lib/ask-client.ts` enforces the header.
  - Verify `RAG_SERVICE_URL` points to the FastAPI service. On Windows PowerShell:

    ```powershell
    Invoke-WebRequest -UseBasicParsing -Method Post `
      -Uri "$env:RAG_SERVICE_URL/ask" `
      -Body '{"question":"ping"}' `
      -ContentType 'application/json'
    ```

- **502 or `upstream_unreachable` errors**
  - Confirm `make api` is running and reachable at the configured port.
  - Inspect the FastAPI logs for request IDs logged via `ask_endpoint_complete`.

- **SSE connection closes immediately**
  - Disable corporate proxies that buffer responses; SSE requires a raw streaming connection.
  - Set `NODE_OPTIONS=--enable-source-maps` when debugging to surface the originating stack trace inside the Next route handler.

---

## Lint / Format Failures

- **Prettier differences** — run `pnpm run format` (writes) or `pnpm run format:check` (CI-friendly). Tailwind class order is enforced via `prettier-plugin-tailwindcss`.
- **ESLint violations** — run `pnpm run lint`. The configuration uses the tailwindcss plugin; ensure utility classes flow through the `cn` helper.
- **Ruff or mypy failures** — use `make format` (auto-fix) and `make typecheck` to reproduce Python findings.
- **Full parity check** — `make quality` mirrors CI across Python + Next.js tooling.

---

## Pre-commit hook failures

Install hooks with `pre-commit install`. To re-run everything after fixing issues:

```bash
pre-commit run --all-files --show-diff-on-failure
```

If local Node tooling drifts, reinstall via `pnpm install` and retry.

---

## Dependency installation failures

- Capture Python failures with `mkdir -p logs/install && pip-sync requirements.txt 2>&1 | tee logs/install/pip-sync.log` and attach the log to incident notes.
- Capture Node failures with `mkdir -p logs/install && pnpm install --reporter=ndjson 2>&1 | tee logs/install/pnpm-install.log`; redact tokens before sharing.
- Archive both logs under `logs/install/` for the current date and reference them from the audit trail.

---

## pnpm audit warnings

`pnpm audit` currently reports a critical Next.js middleware advisory (GHSA-f82v-jwr5-mffw) plus moderate issues in Next.js, esbuild, vite, and vitest. No fixed versions are available as of 2025-09-28; monitor upstream releases and capture justifications in `reports/ci/pnpm-audit-latest.json` (see [OPERATIONS.md](OPERATIONS.md#dependency-risk-exceptions)).

---

## Rate Limiting & 429 Responses

- `429 rate_limited` responses mean the user/IP exceeded `RATE_LIMIT_REQUESTS` within `RATE_LIMIT_WINDOW_SECONDS`.
- Inspect `logs/app.jsonl` for `rate_limit_blocked` entries; identifiers are hashed (first 12 hex chars) for privacy.
- Adjust thresholds in `.env` or introduce per-tenant overrides before raising limits globally.
- `/admin/metrics` exposes rate-limit counters (`blocked`) alongside query/escalation statistics.

---

## Index and Retrieval Issues

- **Rollback to a known-good index**:

  ```bash
  python scripts/rollback.py --manifest indices/manifest.json
  ```

- **Smoke test after rollback**:

  ```bash
  make eval
  ```

- If retrieval quality drops (low nDCG or Recall), re-run `make ingest` and re-check chunking settings.

---

## Quick Diagnostic Commands

| Action                         | Command                                    |
| ------------------------------ | ------------------------------------------ |
| Check environment fingerprints | `python scripts/debug_env.py`              |
| Tail live logs                 | `tail -f logs/app.jsonl`                   |
| Check errors only              | `tail -f logs/errors.jsonl`                |
| Fetch metrics dashboard        | `curl http://localhost:8000/admin/metrics` |
| Full end-to-end smoke test     | `make e2e`                                 |

---

## References

- [README.md](../README.md) — installation and setup
- [OPERATIONS.md](OPERATIONS.md) — detailed runbooks and evaluation metrics
- [SECURITY.md](SECURITY.md) — secret handling and IAM policy examples
