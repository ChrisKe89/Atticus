# REQUIREMENTS — Atticus

This document defines the runtime and build requirements for Atticus.
Use it to set up development environments, run CI, and deploy production services.

---

## Core Runtime

- **Python 3.12** — Required for both development and production.
- **Node.js 20 LTS** — Required for the Next.js workspace, lint/typecheck/build, and audit scripts.
- **Operating System** — Linux or Windows. Windows users should ensure Tesseract and Ghostscript are installed if PDF OCR is needed.

---

## Python Dependencies

Dependencies are managed with `pip-tools` for deterministic builds.

- `requirements.in` — human-maintained top‑level packages.
- `requirements.txt` — fully pinned output generated by:
  ```bash
  pip-compile -U requirements.in
  ```
- Synchronize the environment with:
  ```bash
  pip-sync requirements.txt
  ```

Typical core packages include:

- `fastapi`, `uvicorn`
- `pydantic`, `python-dotenv`
- `pgvector`, `psycopg`, `numpy`, `scikit-learn`, `rapidfuzz`
- `pymupdf`, `pdfminer.six`, `pytesseract`, `Pillow`
- `pytest`, `pytest-cov`

These are already captured and pinned in `requirements.in` and `requirements.txt`.

---

## Node & Frontend Dependencies

Managed via `package.json` / `package-lock.json` with `npm install`.

Key packages:

- `next@14.2.5`, `react@18`, `react-dom@18`
- `next-auth@4` with `@auth/prisma-adapter`
- `tailwindcss@3`, `shadcn/ui` components, `lucide-react`
- `typescript@5.4`, `eslint@8.57`, `eslint-config-next`, `eslint-plugin-tailwindcss`
- `prettier@3.3` + `prettier-plugin-tailwindcss`
- Tooling: `knip`, `vitest`, `@playwright/test`

Install once with `npm install` (POSIX/PowerShell). Use `npm ci` inside CI.

---

## Environment Variables

All runtime configuration is supplied through `.env` (generated by `scripts/generate_env.py`).
Key variables include:

| Variable                                           | Purpose                                                                                   |
| -------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `OPENAI_API_KEY`                                   | Access key for GPT and embeddings                                                         |
| `GEN_MODEL`                                        | Generation model (default `gpt-4.1`)                                                      |
| `EMBED_MODEL`                                      | Embedding model (default `text-embedding-3-large`)                                        |
| `DATABASE_URL`                                     | Postgres connection string for pgvector                                                   |
| `NEXTAUTH_SECRET`, `NEXTAUTH_URL`                  | Auth.js session signing and callback origin                                               |
| `EMAIL_SERVER`, `EMAIL_FROM`                       | Auth.js email provider configuration                                                      |
| `CONTACT_EMAIL`, `SMTP_*`, `SMTP_ALLOW_LIST`       | Escalation email settings and allow-list guardrail                                        |
| `AUTH_DEBUG_MAILBOX_DIR`                           | Local directory where magic-link emails are written in dev. Defaults to `./logs/mailbox`. |
| `RAG_SERVICE_URL`                                  | Base URL for FastAPI retrieval service proxied by Next.js                                 |
| `ENABLE_RERANKER`                                  | Toggle hybrid reranking (defaults to disabled)                                            |
| `SMTP_DRY_RUN`                                     | Log escalation attempts without sending email                                             |
| `RATE_LIMIT_REQUESTS`, `RATE_LIMIT_WINDOW_SECONDS` | Per-user/IP rate limit configuration                                                      |
| `LOG_VERBOSE`, `LOG_TRACE`                         | Enable structured trace logging                                                           |

Run `python scripts/debug_env.py` to verify that environment settings are sourced and fingerprinted correctly.

---

## Development Tooling

- **Ruff** for linting and import sorting (`make lint`, `make format`).
- **mypy** for static type checking (`make typecheck`).
- **pytest** for testing (`make test`), with a target of ≥90% coverage.
- **ESLint** (`npm run lint`) with the Tailwind plugin for shadcn/ui class validation.
- **Prettier** (`npm run format`, `npm run format:check`) with tailwindcss plugin enforcing class order.
- **TypeScript compiler** (`npm run typecheck`) and **Next.js build** (`npm run build`).
- **Vitest / Playwright** for unit and smoke testing (`npm run test:unit`, `npm run test:e2e`).
- Optional: `pytest-xdist` for parallel test runs; if installed, Makefile will automatically add `-n auto`.
- **pre-commit** hooks covering Ruff, mypy, ESLint, Prettier, markdownlint (`pre-commit install`).

---

## CI Expectations

Local workflows must mirror CI:

- Run `make quality` before pushing.
- Ensure audit artifacts under `reports/ci/` remain ignored locally (`.gitignore` handles this).
- GitHub Actions jobs `frontend-quality`, `lint-test`, and `pgvector-check` enforce the same commands with Node 20 + Python 3.12 matrices.

---

## Deployment

- Use Docker Compose for reproducible production deployments.
- Ensure `.env` is present and up to date before running:
  ```bash
  docker compose up --build
  ```
- The default configuration exposes the API at `http://localhost:8000` with TLS termination handled by Nginx.

---

## Versioning

- Project version lives in [`VERSION`](../VERSION) and must match `package.json`.
- Update [CHANGELOG.md](../CHANGELOG.md) and [RELEASE.md](RELEASE.md) on every release.
- Tag releases using semantic versioning (`vX.Y.Z`) after CI passes.

---

## References

- [README.md](../README.md) — overall setup and Makefile targets.
- [AGENTS.md](AGENTS.md) — agent roles and configuration.
- [SECURITY.md](SECURITY.md) — secrets handling and IAM guidance.
