# AGENTS — Atticus

## Purpose

Atticus is a Retrieval‑Augmented Generation (RAG) assistant built to **help Sales teams answer questions faster**, reduce **Service** and **Marketing** interruptions, and **accelerate tender responses**.
It ingests your content, retrieves the most relevant passages, and produces grounded answers with inline citations. If confidence falls below the set threshold, Atticus provides a cautious partial answer and escalates via email.

---

## Scope and Responsibilities

| Stage | What Happens | Key Components |
|-------|-------------|----------------|
| **Ingest & Index** | Parse → chunk → embed → persist index | Python scripts, FAISS |
| **Retrieve & Rank** | Hybrid dense + keyword retrieval; optional re-ranker (planned) | FAISS, BM25-lite |
| **Generate Answer** | `GEN_MODEL` drafts a concise, sourced reply | GPT‑4.1 |
| **Confidence & Escalation** | If `confidence < CONFIDENCE_THRESHOLD`, return a careful partial answer and send an escalation email | SES SMTP |
| **UI Contract** | Web UI at `/` with left menu **CONTACT** and right-side chat | FastAPI + Jinja2 |

---

## Configuration

Settings are taken from `.env` generated by `scripts/generate_env.py`.
Host environment variables can override unless `ATTICUS_ENV_PRIORITY=env` is set.

| Category | Important Keys | Default / Notes |
|----------|---------------|------------------|
| Models | `GEN_MODEL`, `EMBED_MODEL`, `EMBEDDING_MODEL_VERSION` | `gpt-4.1`, `text-embedding-3-large@2025-01-15` |
| Retrieval | `CONFIDENCE_THRESHOLD`, `MAX_CONTEXT_CHUNKS` | Default confidence = `0.70` |
| Chunking | `CHUNK_TARGET_TOKENS`, `CHUNK_MIN_TOKENS`, `CHUNK_OVERLAP_TOKENS` | Balances context and speed |
| Content | `CONTENT_DIR` | Default `./content` |
| Email | `CONTACT_EMAIL`, `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM` | SES SMTP credentials only |

Diagnostics:
```bash
python scripts/debug_env.py
```

---

## Lifecycle

1. **Add or update docs** under `content/` using `YYYYMMDD_topic_version.ext` naming.
2. **Ingest** with `make ingest` to parse, chunk, embed, and rebuild the index.
3. **Evaluate** retrieval quality with `make eval`; check metrics in `eval/runs/<timestamp>/metrics.json`.
4. **Serve** with `make api`. Users can ask questions via the integrated UI or `/ask` endpoint.
5. **Escalate if needed**: queries below the confidence threshold trigger email escalation.

---

## Error Handling

Atticus returns **clear JSON errors** designed for easy testing and log parsing.

Examples:
```json
200 OK
{
  "answer": "...",
  "sources": [{"path": "content/example.pdf", "page": 3}],
  "confidence": 0.82,
  "request_id": "abc123"
}
```
```json
400 Validation
{
  "error": "validation_error",
  "detail": "'query' is required",
  "fields": {"query": "missing"},
  "request_id": "abc123"
}
```
```json
422 Partial ingestion
{
  "status": "partial",
  "succeeded": 12,
  "failed": 1,
  "errors": [{"doc": "/content/x.pdf", "reason": "pdf parse failed"}],
  "request_id": "abc123"
}
```
```json
5xx Internal
{
  "error": "internal_error",
  "detail": "see logs",
  "request_id": "abc123"
}
```

Guidelines:
* Include **what** failed, **where** it failed, and a unique `request_id`.
* Preserve stack traces in server logs but never log secrets.
* Skip corrupted data instead of storing it.

---

## Testing

* **Unit tests** mock SMTP so CI never sends real email.
* **Retrieval evaluation** checks against a gold set and fails CI if regression exceeds the threshold.
* **Coverage target**: >=90%, with exemptions tracked in `pyproject.toml`.

---

## File/Folder Glossary

| Location | Purpose |
|----------|--------|
| `content/` | Source documents to ingest |
| `indices/` | Vector index and `manifest.json` snapshot |
| `eval/` | Gold sets and evaluation runs |
| `logs/` | `app.jsonl` (info) and `errors.jsonl` (errors) |

---

## Security Guardrails

* `.env` is required; no hard-coded secrets.
* Use **SES SMTP credentials**, never IAM keys.
* Apply IAM policies to restrict `ses:FromAddress` to approved senders and region (see [SECURITY.md](SECURITY.md)).
* Redact PII in logs and traces.

---

## Open Questions / TODOs

* Define a clear escalation vs. refusal policy.
* Confirm re-ranker strategy and document any env flags.
* List allowed or blocked content categories for refusal rules.

---

*For operational runbooks, snapshot/rollback instructions, and OpenAPI regeneration, see [`OPERATIONS.md`](OPERATIONS.md).*

