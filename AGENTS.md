# Atticus — AGENTS.md (updated)

## Purpose
Atticus is a RAG (Retrieval-Augmented Generation) assistant for FUJIFILM Business Innovation AU.
It answers product/service questions with grounded citations, escalates low-confidence cases,
and provides a simple web UI with a CONTACT action that emails the escalation mailbox.

## Components
- **Ingestion & Indexing**: parse → chunk → embed → persist.
- **Retriever & Ranker**: hybrid retrieval, rerank to top-K.
- **Generator**: {"GEN_MODEL"} summarises with inline citations and refusal rules.
- **Escalation**: if confidence < `CONFIDENCE_THRESHOLD`, create an email via SMTP.
- **UI**: left side menu (CONTACT), right panel chat (scrollable history, input at bottom).

## Environment Variables
The app reads all configuration from `.env` (generated by `scripts/generate_env.py`).

| Key | Description | Default |
|---|---|---|
| OPENAI_API_KEY | OpenAI API key for embeddings/generation | (empty) |
| OPENAI_MODEL | Default LLM for agent/function calls | gpt-4.1 |
| GEN_MODEL | Generation model for answers | gpt-4.1 |
| EMBED_MODEL | Embedding model name | text-embedding-3-large |
| EMBEDDING_MODEL_VERSION | Embed model version pin | text-embedding-3-large@2025-01-15 |
| CONFIDENCE_THRESHOLD | Escalate when model confidence below this | 0.70 |
| CHUNK_TARGET_TOKENS | Target tokens per chunk | 512 |
| CHUNK_MIN_TOKENS | Minimum tokens per chunk | 256 |
| CHUNK_OVERLAP_TOKENS | Overlap between neighbor chunks | 100 |
| MAX_CONTEXT_CHUNKS | Chunks to stuff into context | 10 |
| LOG_LEVEL | Logging verbosity | INFO |
| TIMEZONE | Server/application timezone | UTC |
| EVAL_REGRESSION_THRESHOLD | % allowed regression on metrics | 3.0 |
| CONTENT_DIR | Path to ingestible content | ./content |
| CONTACT_EMAIL | Address exposed in UI "CONTACT" action | (empty) |
| SMTP_HOST | Mail server | (empty) |
| SMTP_PORT | Mail server port | 587 |
| SMTP_USER | SMTP username | (empty) |
| SMTP_PASS | SMTP password | (empty) |
| SMTP_FROM | From address for escalation emails | (empty) |
| SMTP_TO | To address for escalation emails (if different) | (empty) |

## Confidence & Escalation
- Compute an answer confidence (retrieval density + reranker score + model self-rating).
- If `< CONFIDENCE_THRESHOLD`, the agent **does not guess**; it:
  1) Returns a concise partial answer (if safe), and
  2) Triggers the **CONTACT** flow: POST `/contact` → SMTP email to `SMTP_TO or CONTACT_EMAIL` with the chat transcript, retrieved sources, and request metadata.

## UI Contract
- Single left menu item **CONTACT**; collapsible.
- Right side chat: conversation stream scrolls **above** the input; input anchored at the bottom; viewport height aligned to or below the top of the side menu.
- Icons/logos are **placeholders** (file paths documented in FRONTEND.md).

## Logging & Telemetry
- Log ingestion stats (doc counts, chunks, token ranges).
- Log retrieval metrics in eval runs (nDCG@10, Recall@50, MRR).
- Redact secrets; do not log SMTP credentials or API keys.

## Security
- `.env` is mandatory for secrets; never hard-code keys.
- SMTP must use STARTTLS (587) or SMTPS.
- PII: redact email bodies in logs except message IDs.

## Runbooks
- See `OPERATIONS.md` for ingestion/index snapshotting, rollback, and log triage.
- See `FRONTEND.md` for UI build/run details.
- See `TROUBLESHOOTING.md` for Windows dependencies (Tesseract/Ghostscript), PDF parsing pitfalls, and chunking gotchas.
